"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[6137],{7195:(s,e,a)=>{a.r(e),a.d(e,{assets:()=>h,contentTitle:()=>m,default:()=>p,frontMatter:()=>c,metadata:()=>n,toc:()=>o});const n=JSON.parse('{"id":"tutorials/optimize_stochastic/index","title":"Acquisition function optimization with torch.optim","description":"<LinkButtons","source":"@site/versioned_docs/version-v0.13.0/tutorials/optimize_stochastic/index.mdx","sourceDirName":"tutorials/optimize_stochastic","slug":"/tutorials/optimize_stochastic/","permalink":"/botorch/docs/tutorials/optimize_stochastic/","draft":false,"unlisted":false,"editUrl":"https://github.com/pytorch/botorch/edit/main/docs/versioned_docs/version-v0.13.0/tutorials/optimize_stochastic/index.mdx","tags":[],"version":"v0.13.0","lastUpdatedBy":"Cristian Lara","lastUpdatedAt":1734367864000,"frontMatter":{"title":"Acquisition function optimization with torch.optim","sidebar_label":"Acquisition function optimization with torch.optim"},"sidebar":"tutorials","previous":{"title":"Acquisition function optimization with CMA-ES","permalink":"/botorch/docs/tutorials/optimize_with_cmaes/"},"next":{"title":"Using batch evaluation for fast cross-validation","permalink":"/botorch/docs/tutorials/batch_mode_cross_validation/"}}');var i=a(4848),t=a(8453),l=a(8987),r=a(1023);a(290);const c={title:"Acquisition function optimization with torch.optim",sidebar_label:"Acquisition function optimization with torch.optim"},m=void 0,h={},o=[{value:"Optimize acquisition functions using torch.optim",id:"optimize-acquisition-functions-using-torchoptim",level:2},{value:"Set up a toy model",id:"set-up-a-toy-model",level:3},{value:"Define acquisition function",id:"define-acquisition-function",level:3},{value:"Optimizing the acquisition function",id:"optimizing-the-acquisition-function",level:3},{value:"Choosing initial conditions via a heuristic",id:"choosing-initial-conditions-via-a-heuristic",level:4},{value:"Optimizing the acquisition function",id:"optimizing-the-acquisition-function-1",level:4}];function d(s){const e={a:"a",annotation:"annotation",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",li:"li",math:"math",mfrac:"mfrac",mi:"mi",mn:"mn",mo:"mo",mover:"mover",mrow:"mrow",mspace:"mspace",msub:"msub",msubsup:"msubsup",msup:"msup",mtext:"mtext",ol:"ol",p:"p",pre:"pre",semantics:"semantics",span:"span",strong:"strong",...(0,t.R)(),...s.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(l.A,{githubUrl:"https://github.com/cristianlara/botorch/blob/v0.13.0/tutorials/optimize_stochastic/optimize_stochastic.ipynb",colabUrl:"https://colab.research.google.com/github/cristianlara/botorch/blob/v0.13.0/tutorials/optimize_stochastic/optimize_stochastic.ipynb"}),"\n",(0,i.jsx)(e.h2,{id:"optimize-acquisition-functions-using-torchoptim",children:"Optimize acquisition functions using torch.optim"}),"\n",(0,i.jsxs)(e.p,{children:["In this tutorial, we show how to use PyTorch's ",(0,i.jsx)(e.code,{children:"optim"})," module for optimizing BoTorch MC\nacquisition functions. This is useful if the acquisition function is stochastic in\nnature (caused by re-sampling the base samples when using the reparameterization trick,\nor if the model posterior itself is stochastic)."]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.em,{children:"Note:"})," A pre-packaged, more user-friendly version of the optimization loop we will\ndevelop below is contained in the ",(0,i.jsx)(e.code,{children:"gen_candidates_torch"})," function in the ",(0,i.jsx)(e.code,{children:"botorch.gen"}),"\nmodule. This tutorial should be quite useful if you would like to implement custom\noptimizers beyond what is contained in ",(0,i.jsx)(e.code,{children:"gen_candidates_torch"}),"."]}),"\n",(0,i.jsxs)(e.p,{children:["As discussed in the ",(0,i.jsx)(e.a,{href:"./optimize_with_cmaes",children:"CMA-ES tutorial"}),", for deterministic\nacquisition functions BoTorch uses quasi-second order methods (such as L-BFGS-B or\nSLSQP) by default, which provide superior convergence speed in this situation."]}),"\n",(0,i.jsx)(e.h3,{id:"set-up-a-toy-model",children:"Set up a toy model"}),"\n",(0,i.jsxs)(e.p,{children:["We'll fit a ",(0,i.jsx)(e.code,{children:"SingleTaskGP"})," model on noisy observations of the function\n",(0,i.jsxs)(e.span,{className:"katex",children:[(0,i.jsx)(e.span,{className:"katex-mathml",children:(0,i.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,i.jsxs)(e.semantics,{children:[(0,i.jsxs)(e.mrow,{children:[(0,i.jsx)(e.mi,{children:"f"}),(0,i.jsx)(e.mo,{stretchy:"false",children:"("}),(0,i.jsx)(e.mi,{children:"x"}),(0,i.jsx)(e.mo,{stretchy:"false",children:")"}),(0,i.jsx)(e.mo,{children:"="}),(0,i.jsx)(e.mn,{children:"1"}),(0,i.jsx)(e.mo,{children:"\u2212"}),(0,i.jsx)(e.mi,{mathvariant:"normal",children:"\u2225"}),(0,i.jsx)(e.mi,{children:"x"}),(0,i.jsxs)(e.msub,{children:[(0,i.jsx)(e.mi,{mathvariant:"normal",children:"\u2225"}),(0,i.jsx)(e.mn,{children:"2"})]})]}),(0,i.jsx)(e.annotation,{encoding:"application/x-tex",children:"f(x) = 1 - \\|x\\|_2"})]})})}),(0,i.jsxs)(e.span,{className:"katex-html","aria-hidden":"true",children:[(0,i.jsxs)(e.span,{className:"base",children:[(0,i.jsx)(e.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,i.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.10764em"},children:"f"}),(0,i.jsx)(e.span,{className:"mopen",children:"("}),(0,i.jsx)(e.span,{className:"mord mathnormal",children:"x"}),(0,i.jsx)(e.span,{className:"mclose",children:")"}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,i.jsx)(e.span,{className:"mrel",children:"="}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,i.jsxs)(e.span,{className:"base",children:[(0,i.jsx)(e.span,{className:"strut",style:{height:"0.7278em",verticalAlign:"-0.0833em"}}),(0,i.jsx)(e.span,{className:"mord",children:"1"}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2222em"}}),(0,i.jsx)(e.span,{className:"mbin",children:"\u2212"}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2222em"}})]}),(0,i.jsxs)(e.span,{className:"base",children:[(0,i.jsx)(e.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,i.jsx)(e.span,{className:"mord",children:"\u2225"}),(0,i.jsx)(e.span,{className:"mord mathnormal",children:"x"}),(0,i.jsxs)(e.span,{className:"mord",children:[(0,i.jsx)(e.span,{className:"mord",children:"\u2225"}),(0,i.jsx)(e.span,{className:"msupsub",children:(0,i.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,i.jsxs)(e.span,{className:"vlist-r",children:[(0,i.jsx)(e.span,{className:"vlist",style:{height:"0.3011em"},children:(0,i.jsxs)(e.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"},children:[(0,i.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,i.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,i.jsx)(e.span,{className:"mord mtight",children:"2"})})]})}),(0,i.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,i.jsx)(e.span,{className:"vlist-r",children:(0,i.jsx)(e.span,{className:"vlist",style:{height:"0.15em"},children:(0,i.jsx)(e.span,{})})})]})})]})]})]})]})," in ",(0,i.jsx)(e.code,{children:"d=5"})," dimensions on the hypercube ",(0,i.jsxs)(e.span,{className:"katex",children:[(0,i.jsx)(e.span,{className:"katex-mathml",children:(0,i.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,i.jsxs)(e.semantics,{children:[(0,i.jsxs)(e.mrow,{children:[(0,i.jsx)(e.mo,{stretchy:"false",children:"["}),(0,i.jsx)(e.mo,{children:"\u2212"}),(0,i.jsx)(e.mn,{children:"1"}),(0,i.jsx)(e.mo,{separator:"true",children:","}),(0,i.jsx)(e.mn,{children:"1"}),(0,i.jsxs)(e.msup,{children:[(0,i.jsx)(e.mo,{stretchy:"false",children:"]"}),(0,i.jsx)(e.mi,{children:"d"})]})]}),(0,i.jsx)(e.annotation,{encoding:"application/x-tex",children:"[-1, 1]^d"})]})})}),(0,i.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,i.jsxs)(e.span,{className:"base",children:[(0,i.jsx)(e.span,{className:"strut",style:{height:"1.0991em",verticalAlign:"-0.25em"}}),(0,i.jsx)(e.span,{className:"mopen",children:"["}),(0,i.jsx)(e.span,{className:"mord",children:"\u2212"}),(0,i.jsx)(e.span,{className:"mord",children:"1"}),(0,i.jsx)(e.span,{className:"mpunct",children:","}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.1667em"}}),(0,i.jsx)(e.span,{className:"mord",children:"1"}),(0,i.jsxs)(e.span,{className:"mclose",children:[(0,i.jsx)(e.span,{className:"mclose",children:"]"}),(0,i.jsx)(e.span,{className:"msupsub",children:(0,i.jsx)(e.span,{className:"vlist-t",children:(0,i.jsx)(e.span,{className:"vlist-r",children:(0,i.jsx)(e.span,{className:"vlist",style:{height:"0.8491em"},children:(0,i.jsxs)(e.span,{style:{top:"-3.063em",marginRight:"0.05em"},children:[(0,i.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,i.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,i.jsx)(e.span,{className:"mord mathnormal mtight",children:"d"})})]})})})})})]})]})})]}),"."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:"# Install dependencies if we are running in colab\nimport sys\nif 'google.colab' in sys.modules:\n    %pip install botorch\n"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:"import torch\n\nfrom botorch.fit import fit_gpytorch_mll\nfrom botorch.models import SingleTaskGP\nfrom gpytorch.mlls import ExactMarginalLogLikelihood\n"})}),"\n",(0,i.jsx)(r.A,{children:"I1116 182000.166 _utils_internal.py:179] NCCL_DEBUG env var is set to None"}),"\n",(0,i.jsx)(r.A,{children:"I1116 182000.167 _utils_internal.py:188] NCCL_DEBUG is INFO from /etc/nccl.conf"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:"d = 5\n\nbounds = torch.stack([-torch.ones(d), torch.ones(d)])\n\ntrain_X = bounds[0] + (bounds[1] - bounds[0]) * torch.rand(50, d)\ntrain_Y = 1 - torch.linalg.norm(train_X, dim=-1, keepdim=True)\n\nmodel = SingleTaskGP(train_X, train_Y)\nmll = ExactMarginalLogLikelihood(model.likelihood, model)\nfit_gpytorch_mll(mll);\n"})}),"\n",(0,i.jsx)(e.h3,{id:"define-acquisition-function",children:"Define acquisition function"}),"\n",(0,i.jsxs)(e.p,{children:["We'll use ",(0,i.jsx)(e.code,{children:"qExpectedImprovement"})," with a ",(0,i.jsx)(e.code,{children:"StochasticSampler"})," that uses a small number of\nMC samples. This results in a stochastic acquisition function that one should not\nattempt to optimize with the quasi-second order methods that are used by default in\nBoTorch's ",(0,i.jsx)(e.code,{children:"optimize_acqf"})," function."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:"from botorch.acquisition import qExpectedImprovement\nfrom botorch.sampling.stochastic_samplers import StochasticSampler\n\nsampler = StochasticSampler(sample_shape=torch.Size([128]))\nqEI = qExpectedImprovement(model, best_f=train_Y.max(), sampler=sampler)\n"})}),"\n",(0,i.jsx)(e.h3,{id:"optimizing-the-acquisition-function",children:"Optimizing the acquisition function"}),"\n",(0,i.jsxs)(e.p,{children:["We will perform optimization over ",(0,i.jsx)(e.code,{children:"N=5"})," random initial ",(0,i.jsx)(e.code,{children:"q"}),"-batches with ",(0,i.jsx)(e.code,{children:"q=2"})," in\nparallel. We use ",(0,i.jsx)(e.code,{children:"N"})," random restarts because the acquisition function is non-convex and\nas a result we may get stuck in local minima."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:"N = 5\nq = 2\n"})}),"\n",(0,i.jsx)(e.h4,{id:"choosing-initial-conditions-via-a-heuristic",children:"Choosing initial conditions via a heuristic"}),"\n",(0,i.jsx)(e.p,{children:"Using random initial conditions in conjunction with gradient-based optimizers can be\nproblematic because qEI values and their corresponding gradients are often zero in large\nparts of the feature space. To mitigate this issue, BoTorch provides a heuristic for\ngenerating promising initial conditions (this dirty and not-so-little secret of Bayesian\nOptimization is actually very important for overall closed-loop performance)."}),"\n",(0,i.jsxs)(e.p,{children:["Given a set of ",(0,i.jsx)(e.code,{children:"q"}),"-batches ",(0,i.jsxs)(e.span,{className:"katex",children:[(0,i.jsx)(e.span,{className:"katex-mathml",children:(0,i.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,i.jsxs)(e.semantics,{children:[(0,i.jsx)(e.mrow,{children:(0,i.jsxs)(e.msup,{children:[(0,i.jsx)(e.mi,{children:"X"}),(0,i.jsx)(e.mo,{mathvariant:"normal",lspace:"0em",rspace:"0em",children:"\u2032"})]})}),(0,i.jsx)(e.annotation,{encoding:"application/x-tex",children:"X'"})]})})}),(0,i.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,i.jsxs)(e.span,{className:"base",children:[(0,i.jsx)(e.span,{className:"strut",style:{height:"0.7519em"}}),(0,i.jsxs)(e.span,{className:"mord",children:[(0,i.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.07847em"},children:"X"}),(0,i.jsx)(e.span,{className:"msupsub",children:(0,i.jsx)(e.span,{className:"vlist-t",children:(0,i.jsx)(e.span,{className:"vlist-r",children:(0,i.jsx)(e.span,{className:"vlist",style:{height:"0.7519em"},children:(0,i.jsxs)(e.span,{style:{top:"-3.063em",marginRight:"0.05em"},children:[(0,i.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,i.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,i.jsx)(e.span,{className:"mord mtight",children:(0,i.jsx)(e.span,{className:"mord mtight",children:"\u2032"})})})]})})})})})]})]})})]})," and associated acquisiton function values ",(0,i.jsxs)(e.span,{className:"katex",children:[(0,i.jsx)(e.span,{className:"katex-mathml",children:(0,i.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,i.jsxs)(e.semantics,{children:[(0,i.jsx)(e.mrow,{children:(0,i.jsxs)(e.msup,{children:[(0,i.jsx)(e.mi,{children:"Y"}),(0,i.jsx)(e.mo,{mathvariant:"normal",lspace:"0em",rspace:"0em",children:"\u2032"})]})}),(0,i.jsx)(e.annotation,{encoding:"application/x-tex",children:"Y'"})]})})}),(0,i.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,i.jsxs)(e.span,{className:"base",children:[(0,i.jsx)(e.span,{className:"strut",style:{height:"0.7519em"}}),(0,i.jsxs)(e.span,{className:"mord",children:[(0,i.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.22222em"},children:"Y"}),(0,i.jsx)(e.span,{className:"msupsub",children:(0,i.jsx)(e.span,{className:"vlist-t",children:(0,i.jsx)(e.span,{className:"vlist-r",children:(0,i.jsx)(e.span,{className:"vlist",style:{height:"0.7519em"},children:(0,i.jsxs)(e.span,{style:{top:"-3.063em",marginRight:"0.05em"},children:[(0,i.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,i.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,i.jsx)(e.span,{className:"mord mtight",children:(0,i.jsx)(e.span,{className:"mord mtight",children:"\u2032"})})})]})})})})})]})]})})]}),", the\n",(0,i.jsx)(e.code,{children:"initialize_q_batch_nonneg"})," samples promising initial conditions ",(0,i.jsxs)(e.span,{className:"katex",children:[(0,i.jsx)(e.span,{className:"katex-mathml",children:(0,i.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,i.jsxs)(e.semantics,{children:[(0,i.jsx)(e.mrow,{children:(0,i.jsx)(e.mi,{children:"X"})}),(0,i.jsx)(e.annotation,{encoding:"application/x-tex",children:"X"})]})})}),(0,i.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,i.jsxs)(e.span,{className:"base",children:[(0,i.jsx)(e.span,{className:"strut",style:{height:"0.6833em"}}),(0,i.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.07847em"},children:"X"})]})})]})," (without\nreplacement) from the multinomial distribution"]}),"\n",(0,i.jsx)(e.span,{className:"katex-display",children:(0,i.jsxs)(e.span,{className:"katex",children:[(0,i.jsx)(e.span,{className:"katex-mathml",children:(0,i.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block",children:(0,i.jsxs)(e.semantics,{children:[(0,i.jsxs)(e.mrow,{children:[(0,i.jsx)(e.mi,{mathvariant:"double-struck",children:"P"}),(0,i.jsx)(e.mo,{stretchy:"false",children:"("}),(0,i.jsx)(e.mi,{children:"X"}),(0,i.jsx)(e.mo,{children:"="}),(0,i.jsxs)(e.msubsup,{children:[(0,i.jsx)(e.mi,{children:"X"}),(0,i.jsx)(e.mi,{children:"i"}),(0,i.jsx)(e.mo,{mathvariant:"normal",lspace:"0em",rspace:"0em",children:"\u2032"})]}),(0,i.jsx)(e.mo,{stretchy:"false",children:")"}),(0,i.jsx)(e.mo,{children:"\u223c"}),(0,i.jsx)(e.mi,{children:"exp"}),(0,i.jsx)(e.mo,{children:"\u2061"}),(0,i.jsx)(e.mo,{stretchy:"false",children:"("}),(0,i.jsx)(e.mi,{children:"\u03b7"}),(0,i.jsxs)(e.msub,{children:[(0,i.jsxs)(e.mover,{accent:"true",children:[(0,i.jsx)(e.mi,{children:"Y"}),(0,i.jsx)(e.mo,{children:"~"})]}),(0,i.jsx)(e.mi,{children:"i"})]}),(0,i.jsx)(e.mo,{stretchy:"false",children:")"}),(0,i.jsx)(e.mo,{separator:"true",children:","}),(0,i.jsx)(e.mspace,{width:"2em"}),(0,i.jsx)(e.mtext,{children:"where"}),(0,i.jsx)(e.mtext,{children:"\u2005\u200a"}),(0,i.jsx)(e.mtext,{children:"\u2005\u200a"}),(0,i.jsxs)(e.msub,{children:[(0,i.jsxs)(e.mover,{accent:"true",children:[(0,i.jsx)(e.mi,{children:"Y"}),(0,i.jsx)(e.mo,{children:"~"})]}),(0,i.jsx)(e.mi,{children:"i"})]}),(0,i.jsx)(e.mo,{children:"="}),(0,i.jsxs)(e.mfrac,{children:[(0,i.jsxs)(e.mrow,{children:[(0,i.jsxs)(e.msubsup,{children:[(0,i.jsx)(e.mi,{children:"Y"}),(0,i.jsx)(e.mi,{children:"i"}),(0,i.jsx)(e.mo,{mathvariant:"normal",lspace:"0em",rspace:"0em",children:"\u2032"})]}),(0,i.jsx)(e.mo,{children:"\u2212"}),(0,i.jsx)(e.mi,{children:"\u03bc"}),(0,i.jsx)(e.mo,{stretchy:"false",children:"("}),(0,i.jsx)(e.mi,{children:"Y"}),(0,i.jsx)(e.mo,{stretchy:"false",children:")"})]}),(0,i.jsxs)(e.mrow,{children:[(0,i.jsx)(e.mi,{children:"\u03c3"}),(0,i.jsx)(e.mo,{stretchy:"false",children:"("}),(0,i.jsx)(e.mi,{children:"Y"}),(0,i.jsx)(e.mo,{stretchy:"false",children:")"})]})]}),(0,i.jsx)(e.mtext,{children:"\u2005\u200a"}),(0,i.jsx)(e.mtext,{children:"\u2005\u200a"}),(0,i.jsx)(e.mtext,{children:"if"}),(0,i.jsx)(e.mtext,{children:"\u2005\u200a"}),(0,i.jsx)(e.mtext,{children:"\u2005\u200a"}),(0,i.jsxs)(e.msubsup,{children:[(0,i.jsx)(e.mi,{children:"Y"}),(0,i.jsx)(e.mi,{children:"i"}),(0,i.jsx)(e.mo,{mathvariant:"normal",lspace:"0em",rspace:"0em",children:"\u2032"})]}),(0,i.jsx)(e.mo,{children:">"}),(0,i.jsx)(e.mn,{children:"0"})]}),(0,i.jsx)(e.annotation,{encoding:"application/x-tex",children:" \\mathbb{P}(X = X'_i) \\sim \\exp (\\eta \\tilde{Y}_i), \\qquad \\text{where} \\;\\; \\tilde{Y}_i = \\frac{Y'_i - \\mu(Y)}{\\sigma(Y)} \\;\\; \\text{if} \\;\\; Y'_i >0 "})]})})}),(0,i.jsxs)(e.span,{className:"katex-html","aria-hidden":"true",children:[(0,i.jsxs)(e.span,{className:"base",children:[(0,i.jsx)(e.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,i.jsx)(e.span,{className:"mord mathbb",children:"P"}),(0,i.jsx)(e.span,{className:"mopen",children:"("}),(0,i.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.07847em"},children:"X"}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,i.jsx)(e.span,{className:"mrel",children:"="}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,i.jsxs)(e.span,{className:"base",children:[(0,i.jsx)(e.span,{className:"strut",style:{height:"1.0519em",verticalAlign:"-0.25em"}}),(0,i.jsxs)(e.span,{className:"mord",children:[(0,i.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.07847em"},children:"X"}),(0,i.jsx)(e.span,{className:"msupsub",children:(0,i.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,i.jsxs)(e.span,{className:"vlist-r",children:[(0,i.jsxs)(e.span,{className:"vlist",style:{height:"0.8019em"},children:[(0,i.jsxs)(e.span,{style:{top:"-2.453em",marginLeft:"-0.0785em",marginRight:"0.05em"},children:[(0,i.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,i.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,i.jsx)(e.span,{className:"mord mathnormal mtight",children:"i"})})]}),(0,i.jsxs)(e.span,{style:{top:"-3.113em",marginRight:"0.05em"},children:[(0,i.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,i.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,i.jsx)(e.span,{className:"mord mtight",children:(0,i.jsx)(e.span,{className:"mord mtight",children:"\u2032"})})})]})]}),(0,i.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,i.jsx)(e.span,{className:"vlist-r",children:(0,i.jsx)(e.span,{className:"vlist",style:{height:"0.247em"},children:(0,i.jsx)(e.span,{})})})]})})]}),(0,i.jsx)(e.span,{className:"mclose",children:")"}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,i.jsx)(e.span,{className:"mrel",children:"\u223c"}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,i.jsxs)(e.span,{className:"base",children:[(0,i.jsx)(e.span,{className:"strut",style:{height:"1.1702em",verticalAlign:"-0.25em"}}),(0,i.jsx)(e.span,{className:"mop",children:"exp"}),(0,i.jsx)(e.span,{className:"mopen",children:"("}),(0,i.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.03588em"},children:"\u03b7"}),(0,i.jsxs)(e.span,{className:"mord",children:[(0,i.jsx)(e.span,{className:"mord accent",children:(0,i.jsx)(e.span,{className:"vlist-t",children:(0,i.jsx)(e.span,{className:"vlist-r",children:(0,i.jsxs)(e.span,{className:"vlist",style:{height:"0.9202em"},children:[(0,i.jsxs)(e.span,{style:{top:"-3em"},children:[(0,i.jsx)(e.span,{className:"pstrut",style:{height:"3em"}}),(0,i.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.22222em"},children:"Y"})]}),(0,i.jsxs)(e.span,{style:{top:"-3.6023em"},children:[(0,i.jsx)(e.span,{className:"pstrut",style:{height:"3em"}}),(0,i.jsx)(e.span,{className:"accent-body",style:{left:"-0.25em"},children:(0,i.jsx)(e.span,{className:"mord",children:"~"})})]})]})})})}),(0,i.jsx)(e.span,{className:"msupsub",children:(0,i.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,i.jsxs)(e.span,{className:"vlist-r",children:[(0,i.jsx)(e.span,{className:"vlist",style:{height:"0.3117em"},children:(0,i.jsxs)(e.span,{style:{top:"-2.55em",marginLeft:"-0.2222em",marginRight:"0.05em"},children:[(0,i.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,i.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,i.jsx)(e.span,{className:"mord mathnormal mtight",children:"i"})})]})}),(0,i.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,i.jsx)(e.span,{className:"vlist-r",children:(0,i.jsx)(e.span,{className:"vlist",style:{height:"0.15em"},children:(0,i.jsx)(e.span,{})})})]})})]}),(0,i.jsx)(e.span,{className:"mclose",children:")"}),(0,i.jsx)(e.span,{className:"mpunct",children:","}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"2em"}}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.1667em"}}),(0,i.jsx)(e.span,{className:"mord text",children:(0,i.jsx)(e.span,{className:"mord",children:"where"})}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,i.jsxs)(e.span,{className:"mord",children:[(0,i.jsx)(e.span,{className:"mord accent",children:(0,i.jsx)(e.span,{className:"vlist-t",children:(0,i.jsx)(e.span,{className:"vlist-r",children:(0,i.jsxs)(e.span,{className:"vlist",style:{height:"0.9202em"},children:[(0,i.jsxs)(e.span,{style:{top:"-3em"},children:[(0,i.jsx)(e.span,{className:"pstrut",style:{height:"3em"}}),(0,i.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.22222em"},children:"Y"})]}),(0,i.jsxs)(e.span,{style:{top:"-3.6023em"},children:[(0,i.jsx)(e.span,{className:"pstrut",style:{height:"3em"}}),(0,i.jsx)(e.span,{className:"accent-body",style:{left:"-0.25em"},children:(0,i.jsx)(e.span,{className:"mord",children:"~"})})]})]})})})}),(0,i.jsx)(e.span,{className:"msupsub",children:(0,i.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,i.jsxs)(e.span,{className:"vlist-r",children:[(0,i.jsx)(e.span,{className:"vlist",style:{height:"0.3117em"},children:(0,i.jsxs)(e.span,{style:{top:"-2.55em",marginLeft:"-0.2222em",marginRight:"0.05em"},children:[(0,i.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,i.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,i.jsx)(e.span,{className:"mord mathnormal mtight",children:"i"})})]})}),(0,i.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,i.jsx)(e.span,{className:"vlist-r",children:(0,i.jsx)(e.span,{className:"vlist",style:{height:"0.15em"},children:(0,i.jsx)(e.span,{})})})]})})]}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,i.jsx)(e.span,{className:"mrel",children:"="}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,i.jsxs)(e.span,{className:"base",children:[(0,i.jsx)(e.span,{className:"strut",style:{height:"2.3649em",verticalAlign:"-0.936em"}}),(0,i.jsxs)(e.span,{className:"mord",children:[(0,i.jsx)(e.span,{className:"mopen nulldelimiter"}),(0,i.jsx)(e.span,{className:"mfrac",children:(0,i.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,i.jsxs)(e.span,{className:"vlist-r",children:[(0,i.jsxs)(e.span,{className:"vlist",style:{height:"1.4289em"},children:[(0,i.jsxs)(e.span,{style:{top:"-2.314em"},children:[(0,i.jsx)(e.span,{className:"pstrut",style:{height:"3em"}}),(0,i.jsxs)(e.span,{className:"mord",children:[(0,i.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.03588em"},children:"\u03c3"}),(0,i.jsx)(e.span,{className:"mopen",children:"("}),(0,i.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.22222em"},children:"Y"}),(0,i.jsx)(e.span,{className:"mclose",children:")"})]})]}),(0,i.jsxs)(e.span,{style:{top:"-3.23em"},children:[(0,i.jsx)(e.span,{className:"pstrut",style:{height:"3em"}}),(0,i.jsx)(e.span,{className:"frac-line",style:{borderBottomWidth:"0.04em"}})]}),(0,i.jsxs)(e.span,{style:{top:"-3.677em"},children:[(0,i.jsx)(e.span,{className:"pstrut",style:{height:"3em"}}),(0,i.jsxs)(e.span,{className:"mord",children:[(0,i.jsxs)(e.span,{className:"mord",children:[(0,i.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.22222em"},children:"Y"}),(0,i.jsx)(e.span,{className:"msupsub",children:(0,i.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,i.jsxs)(e.span,{className:"vlist-r",children:[(0,i.jsxs)(e.span,{className:"vlist",style:{height:"0.7519em"},children:[(0,i.jsxs)(e.span,{style:{top:"-2.4413em",marginLeft:"-0.2222em",marginRight:"0.05em"},children:[(0,i.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,i.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,i.jsx)(e.span,{className:"mord mathnormal mtight",children:"i"})})]}),(0,i.jsxs)(e.span,{style:{top:"-3.063em",marginRight:"0.05em"},children:[(0,i.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,i.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,i.jsx)(e.span,{className:"mord mtight",children:(0,i.jsx)(e.span,{className:"mord mtight",children:"\u2032"})})})]})]}),(0,i.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,i.jsx)(e.span,{className:"vlist-r",children:(0,i.jsx)(e.span,{className:"vlist",style:{height:"0.2587em"},children:(0,i.jsx)(e.span,{})})})]})})]}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2222em"}}),(0,i.jsx)(e.span,{className:"mbin",children:"\u2212"}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2222em"}}),(0,i.jsx)(e.span,{className:"mord mathnormal",children:"\u03bc"}),(0,i.jsx)(e.span,{className:"mopen",children:"("}),(0,i.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.22222em"},children:"Y"}),(0,i.jsx)(e.span,{className:"mclose",children:")"})]})]})]}),(0,i.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,i.jsx)(e.span,{className:"vlist-r",children:(0,i.jsx)(e.span,{className:"vlist",style:{height:"0.936em"},children:(0,i.jsx)(e.span,{})})})]})}),(0,i.jsx)(e.span,{className:"mclose nulldelimiter"})]}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,i.jsx)(e.span,{className:"mord text",children:(0,i.jsx)(e.span,{className:"mord",children:"if"})}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,i.jsxs)(e.span,{className:"mord",children:[(0,i.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.22222em"},children:"Y"}),(0,i.jsx)(e.span,{className:"msupsub",children:(0,i.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,i.jsxs)(e.span,{className:"vlist-r",children:[(0,i.jsxs)(e.span,{className:"vlist",style:{height:"0.8019em"},children:[(0,i.jsxs)(e.span,{style:{top:"-2.453em",marginLeft:"-0.2222em",marginRight:"0.05em"},children:[(0,i.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,i.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,i.jsx)(e.span,{className:"mord mathnormal mtight",children:"i"})})]}),(0,i.jsxs)(e.span,{style:{top:"-3.113em",marginRight:"0.05em"},children:[(0,i.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,i.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,i.jsx)(e.span,{className:"mord mtight",children:(0,i.jsx)(e.span,{className:"mord mtight",children:"\u2032"})})})]})]}),(0,i.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,i.jsx)(e.span,{className:"vlist-r",children:(0,i.jsx)(e.span,{className:"vlist",style:{height:"0.247em"},children:(0,i.jsx)(e.span,{})})})]})})]}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,i.jsx)(e.span,{className:"mrel",children:">"}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,i.jsxs)(e.span,{className:"base",children:[(0,i.jsx)(e.span,{className:"strut",style:{height:"0.6444em"}}),(0,i.jsx)(e.span,{className:"mord",children:"0"})]})]})]})}),"\n",(0,i.jsxs)(e.p,{children:["and ",(0,i.jsxs)(e.span,{className:"katex",children:[(0,i.jsx)(e.span,{className:"katex-mathml",children:(0,i.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,i.jsxs)(e.semantics,{children:[(0,i.jsxs)(e.mrow,{children:[(0,i.jsx)(e.mi,{mathvariant:"double-struck",children:"P"}),(0,i.jsx)(e.mo,{stretchy:"false",children:"("}),(0,i.jsx)(e.mi,{children:"X"}),(0,i.jsx)(e.mo,{children:"="}),(0,i.jsxs)(e.msubsup,{children:[(0,i.jsx)(e.mi,{children:"X"}),(0,i.jsx)(e.mi,{children:"j"}),(0,i.jsx)(e.mo,{mathvariant:"normal",lspace:"0em",rspace:"0em",children:"\u2032"})]}),(0,i.jsx)(e.mo,{stretchy:"false",children:")"}),(0,i.jsx)(e.mo,{children:"="}),(0,i.jsx)(e.mn,{children:"0"})]}),(0,i.jsx)(e.annotation,{encoding:"application/x-tex",children:"\\mathbb{P}(X = X'_j) = 0"})]})})}),(0,i.jsxs)(e.span,{className:"katex-html","aria-hidden":"true",children:[(0,i.jsxs)(e.span,{className:"base",children:[(0,i.jsx)(e.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,i.jsx)(e.span,{className:"mord mathbb",children:"P"}),(0,i.jsx)(e.span,{className:"mopen",children:"("}),(0,i.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.07847em"},children:"X"}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,i.jsx)(e.span,{className:"mrel",children:"="}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,i.jsxs)(e.span,{className:"base",children:[(0,i.jsx)(e.span,{className:"strut",style:{height:"1.1467em",verticalAlign:"-0.3948em"}}),(0,i.jsxs)(e.span,{className:"mord",children:[(0,i.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.07847em"},children:"X"}),(0,i.jsx)(e.span,{className:"msupsub",children:(0,i.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,i.jsxs)(e.span,{className:"vlist-r",children:[(0,i.jsxs)(e.span,{className:"vlist",style:{height:"0.7519em"},children:[(0,i.jsxs)(e.span,{style:{top:"-2.4413em",marginLeft:"-0.0785em",marginRight:"0.05em"},children:[(0,i.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,i.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,i.jsx)(e.span,{className:"mord mathnormal mtight",style:{marginRight:"0.05724em"},children:"j"})})]}),(0,i.jsxs)(e.span,{style:{top:"-3.063em",marginRight:"0.05em"},children:[(0,i.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,i.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,i.jsx)(e.span,{className:"mord mtight",children:(0,i.jsx)(e.span,{className:"mord mtight",children:"\u2032"})})})]})]}),(0,i.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,i.jsx)(e.span,{className:"vlist-r",children:(0,i.jsx)(e.span,{className:"vlist",style:{height:"0.3948em"},children:(0,i.jsx)(e.span,{})})})]})})]}),(0,i.jsx)(e.span,{className:"mclose",children:")"}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,i.jsx)(e.span,{className:"mrel",children:"="}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,i.jsxs)(e.span,{className:"base",children:[(0,i.jsx)(e.span,{className:"strut",style:{height:"0.6444em"}}),(0,i.jsx)(e.span,{className:"mord",children:"0"})]})]})]})," for all ",(0,i.jsxs)(e.span,{className:"katex",children:[(0,i.jsx)(e.span,{className:"katex-mathml",children:(0,i.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,i.jsxs)(e.semantics,{children:[(0,i.jsx)(e.mrow,{children:(0,i.jsx)(e.mi,{children:"j"})}),(0,i.jsx)(e.annotation,{encoding:"application/x-tex",children:"j"})]})})}),(0,i.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,i.jsxs)(e.span,{className:"base",children:[(0,i.jsx)(e.span,{className:"strut",style:{height:"0.854em",verticalAlign:"-0.1944em"}}),(0,i.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.05724em"},children:"j"})]})})]})," such that ",(0,i.jsxs)(e.span,{className:"katex",children:[(0,i.jsx)(e.span,{className:"katex-mathml",children:(0,i.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,i.jsxs)(e.semantics,{children:[(0,i.jsxs)(e.mrow,{children:[(0,i.jsxs)(e.msubsup,{children:[(0,i.jsx)(e.mi,{children:"Y"}),(0,i.jsx)(e.mi,{children:"j"}),(0,i.jsx)(e.mo,{mathvariant:"normal",lspace:"0em",rspace:"0em",children:"\u2032"})]}),(0,i.jsx)(e.mo,{children:"="}),(0,i.jsx)(e.mn,{children:"0"})]}),(0,i.jsx)(e.annotation,{encoding:"application/x-tex",children:"Y'_j = 0"})]})})}),(0,i.jsxs)(e.span,{className:"katex-html","aria-hidden":"true",children:[(0,i.jsxs)(e.span,{className:"base",children:[(0,i.jsx)(e.span,{className:"strut",style:{height:"1.1467em",verticalAlign:"-0.3948em"}}),(0,i.jsxs)(e.span,{className:"mord",children:[(0,i.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.22222em"},children:"Y"}),(0,i.jsx)(e.span,{className:"msupsub",children:(0,i.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,i.jsxs)(e.span,{className:"vlist-r",children:[(0,i.jsxs)(e.span,{className:"vlist",style:{height:"0.7519em"},children:[(0,i.jsxs)(e.span,{style:{top:"-2.4413em",marginLeft:"-0.2222em",marginRight:"0.05em"},children:[(0,i.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,i.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,i.jsx)(e.span,{className:"mord mathnormal mtight",style:{marginRight:"0.05724em"},children:"j"})})]}),(0,i.jsxs)(e.span,{style:{top:"-3.063em",marginRight:"0.05em"},children:[(0,i.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,i.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,i.jsx)(e.span,{className:"mord mtight",children:(0,i.jsx)(e.span,{className:"mord mtight",children:"\u2032"})})})]})]}),(0,i.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,i.jsx)(e.span,{className:"vlist-r",children:(0,i.jsx)(e.span,{className:"vlist",style:{height:"0.3948em"},children:(0,i.jsx)(e.span,{})})})]})})]}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,i.jsx)(e.span,{className:"mrel",children:"="}),(0,i.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,i.jsxs)(e.span,{className:"base",children:[(0,i.jsx)(e.span,{className:"strut",style:{height:"0.6444em"}}),(0,i.jsx)(e.span,{className:"mord",children:"0"})]})]})]}),"."]}),"\n",(0,i.jsx)(e.p,{children:"Fortunately, thanks to the high degree of parallelism in BoTorch, evaluating the\nacquisition function at a large number of randomly chosen points is quite cheap."}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:"from botorch.optim.initializers import initialize_q_batch_nonneg\n\n# generate a large number of random q-batches\nXraw = bounds[0] + (bounds[1] - bounds[0]) * torch.rand(100 * N, q, d)\nYraw = qEI(Xraw)  # evaluate the acquisition function on these q-batches\n\n# apply the heuristic for sampling promising initial conditions\nX, _ = initialize_q_batch_nonneg(Xraw, Yraw, N)\n\n# we'll want gradients for the input\nX.requires_grad_(True);\n"})}),"\n",(0,i.jsx)(e.h4,{id:"optimizing-the-acquisition-function-1",children:"Optimizing the acquisition function"}),"\n",(0,i.jsxs)(e.p,{children:["If you have used PyTorch, the basic optimization loop should be quite familiar. However,\nit is important to note that there is a ",(0,i.jsx)(e.strong,{children:"key difference"})," here compared to training ML\nmodels: When training ML models, one typically computes the gradient of an empirical\nloss function w.r.t. the model's parameters, while here we take the gradient of the\nacquisition function w.r.t. to the candidate set."]}),"\n",(0,i.jsxs)(e.p,{children:["Thus, when setting the optimizer from ",(0,i.jsx)(e.code,{children:"torch.optim"}),", we ",(0,i.jsx)(e.strong,{children:"do not"})," add the acquisition\nfunction's parameters as parameters to optimize (that would be quite bad!)."]}),"\n",(0,i.jsxs)(e.p,{children:["In this example, we use a vanilla ",(0,i.jsx)(e.code,{children:"Adam"})," optimizer with fixed learning rate for a fixed\nnumber of iterations in order to keep things simple. But you can get as fancy as you\nwant with learning rate scheduling, early termination, etc."]}),"\n",(0,i.jsx)(e.p,{children:"A couple of things to note:"}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsxs)(e.li,{children:["Evaluating the acquisition function on the ",(0,i.jsx)(e.code,{children:"N x q x d"}),"-dim inputs means evaluating\n",(0,i.jsx)(e.code,{children:"N"})," ",(0,i.jsx)(e.code,{children:"q"}),"-batches in ",(0,i.jsx)(e.code,{children:"t"}),"-batch mode. The result of this is an ",(0,i.jsx)(e.code,{children:"N"}),"-dim tensor of\nacquisition function values, evaluated independently. To compute the gradient of the\nfull input ",(0,i.jsx)(e.code,{children:"X"})," via back-propagation, we can for convenience just compute the gradient\nof the sum of the losses."]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"torch.optim"}),' does not have good built in support for constraints (general\nconstrained stochastic optimization is hard and still an open research area). Here we\ndo something simple and project the value obtained after taking the gradient step to\nthe feasible set - that is, we perform "projected stochastic gradient descent". Since\nthe feasible set here is a hyperrectangle, this can be done by simple clamping.\nAnother approach would be to transform the feasible interval for each dimension to\nthe real line, e.g. by using a sigmoid function, and then optimizing in the unbounded\ntransformed space.']}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:'# set up the optimizer, make sure to only pass in the candidate set here\noptimizer = torch.optim.Adam([X], lr=0.01)\nX_traj = []  # we\'ll store the results\n\n# run a basic optimization loop\nfor i in range(75):\n    optimizer.zero_grad()\n    # this performs batch evaluation, so this is an N-dim tensor\n    losses = -qEI(X)  # torch.optim minimizes\n    loss = losses.sum()\n\n    loss.backward()  # perform backward pass\n    optimizer.step()  # take a step\n\n    # clamp values to the feasible set\n    for j, (lb, ub) in enumerate(zip(*bounds)):\n        X.data[..., j].clamp_(lb, ub)  # need to do this on the data not X itself\n\n    # store the optimization trajecatory\n    X_traj.append(X.detach().clone())\n\n    if (i + 1) % 15 == 0:\n        print(f"Iteration {i+1:>3}/75 - Loss: {loss.item():>4.3f}")\n\n    # use your favorite convergence criterion here...\n'})}),"\n",(0,i.jsx)(r.A,{children:"Iteration  15/75 - Loss: -0.924\nIteration  30/75 - Loss: -1.281\nIteration  45/75 - Loss: -1.374\nIteration  60/75 - Loss: -1.363"}),"\n",(0,i.jsx)(r.A,{children:"Iteration  75/75 - Loss: -1.361"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python"})})]})}function p(s={}){const{wrapper:e}={...(0,t.R)(),...s.components};return e?(0,i.jsx)(e,{...s,children:(0,i.jsx)(d,{...s})}):d(s)}},1023:(s,e,a)=>{a.d(e,{A:()=>p});a(6540);var n,i=new Uint8Array(16);function t(){if(!n&&!(n="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return n(i)}const l=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;const r=function(s){return"string"==typeof s&&l.test(s)};for(var c=[],m=0;m<256;++m)c.push((m+256).toString(16).substr(1));const h=function(s){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=(c[s[e+0]]+c[s[e+1]]+c[s[e+2]]+c[s[e+3]]+"-"+c[s[e+4]]+c[s[e+5]]+"-"+c[s[e+6]]+c[s[e+7]]+"-"+c[s[e+8]]+c[s[e+9]]+"-"+c[s[e+10]]+c[s[e+11]]+c[s[e+12]]+c[s[e+13]]+c[s[e+14]]+c[s[e+15]]).toLowerCase();if(!r(a))throw TypeError("Stringified UUID is invalid");return a};const o=function(s,e,a){var n=(s=s||{}).random||(s.rng||t)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,e){a=a||0;for(var i=0;i<16;++i)e[a+i]=n[i];return e}return h(n)};var d=a(4848);const p=function(s){return(0,d.jsxs)("div",{style:{backgroundColor:"var(--ifm-pre-background)",marginBottom:"10px",borderRadius:"var(--ifm-global-radius)",overflow:"hidden",padding:"5px",font:"var(--ifm-code-font-size) / var(--ifm-pre-line-height) var(--ifm-font-family-monospace)"},children:[(0,d.jsx)("span",{style:{color:"red"},children:"Out: "}),(0,d.jsx)("pre",{style:{margin:"0px",backgroundColor:"inherit",padding:"8px"},children:s.children.split("\n").map((function(s){return(0,d.jsx)("p",{style:{marginBottom:"0px"},children:s},o())}))})]})}},8987:(s,e,a)=>{a.d(e,{A:()=>l});a(6540);var n=a(8774),i=a(3186),t=a(4848);const l=function(s){var e=s.githubUrl,a=s.colabUrl;return(0,t.jsxs)("div",{className:"margin-top--sm margin-bottom--lg",children:[(0,t.jsxs)(n.A,{to:e,className:"button button--outline button--primary margin-right--xs",children:["Open in GitHub",(0,t.jsx)(i.A,{})]}),(0,t.jsxs)(n.A,{to:a,className:"button button--outline button--primary margin--xs",children:["Run in Google Colab",(0,t.jsx)(i.A,{})]})]})}},290:(s,e,a)=>{a(6540),a(3259),a(2303),a(4848)},8453:(s,e,a)=>{a.d(e,{R:()=>l,x:()=>r});var n=a(6540);const i={},t=n.createContext(i);function l(s){const e=n.useContext(t);return n.useMemo((function(){return"function"==typeof s?s(e):{...e,...s}}),[e,s])}function r(s){let e;return e=s.disableParentContext?"function"==typeof s.components?s.components(i):s.components||i:l(s.components),n.createElement(t.Provider,{value:e},s.children)}}}]);